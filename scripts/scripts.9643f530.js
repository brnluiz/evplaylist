"use strict";angular.module("evplaylistsApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","facebook","youtube-embed"]).config(["$routeProvider",function(a){a.when("/",{title:"Home",templateUrl:"views/main.html",controller:"MainCtrl"}).when("/playlist/:id",{title:"Playlist",templateUrl:"views/player.html",controller:"PlayerCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("evplaylistsApp").controller("MainCtrl",["$scope","$http","$q","Facebook","Page","$location",function(a,b,c,d,e,f){e.setTitle("Home"),a.login=function(){d.login(function(b){"connected"===b.status?a.logged=!0:a.logged=!1})},a.getLoginStatus=function(){d.getLoginStatus(function(b){"connected"===b.status?a.logged=!0:a.logged=!1})},a.eventLink="https://www.facebook.com/events/596649333810675",a.formSubmit=function(){var b=a.getUrlPathInfo(this.eventLink,"events/");f.path("/playlist/"+b)},a.getUrlPathInfo=function(a){var b=document.createElement("a");if(b.href=a,"facebook.com"!==b.host&&"www.facebook.com"!==b.host)return!1;var c=/(\d+)/g,d=a.match(c);if(void 0===d[0])return!1;var e=d[0];return e},d.getLoginStatus(function(b){"connected"===b.status?a.logged=!0:a.logged=!1})}]),angular.module("evplaylistsApp").controller("PlayerCtrl",["$scope","$routeParams","$location","$http","$q","Facebook","Youtube","Page","Player","$interval",function(a,b,c,d,e,f,g,h,i,j){function k(){var a=document.getElementsByClassName("col-player")[0].offsetHeight+"px";return document.body.clientWidth<991?document.getElementsByClassName("music-list")[0].style.height="100%":document.getElementsByClassName("music-list")[0].style.height=a}a.player=i,a.eventLink="https://www.facebook.com/events/596649333810675",a.fbEvent=[],a.eventId=b.id,a.eventLink="https://www.facebook.com/events/"+a.eventId,a.init=function(){document.getElementsByClassName("music-list")[0].onselectstart=function(){return!1},i.reset(),f.api("/"+a.eventId+"?fields=id,name",function(b){a.fbEvent.id=b.id,a.fbEvent.title=b.name,h.setTitle("Playlist: "+a.fbEvent.title)}),f.api("/"+a.eventId+"/feed?fields=link,likes.limit(0).summary(true)&limit=1000",function(b){if(void 0!==b.error)return a.loading=!1,a.error.status=!0,a.error.noevent=!0,!1;if(angular.forEach(b.data,function(a){var b=g.getId(a.link),c=i.musics.map(function(a){return a.ytid});if(b!==!1){var d=c.indexOf(b);-1!==d?i.musics[d].rank=i.musics[d].rank+a.rank:(a.ytid=b,a.rank=a.likes.summary.total_count,i.musics.push(a))}}),0==i.musics.length)return a.loading=!1,a.error.status=!0,a.error.nocontent=!0,!1;var c=[],d="",f=0;angular.forEach(i.musics,function(a){20===f&&(d=d.substr(1),c.push(g.getData(d)),d="",f=0),d=d+","+a.ytid,f++}),d=d.substr(1),c.push(g.getData(d)),e.all(c).then(function(a){var b=i.musics.map(function(a){return a.ytid}),c=[];angular.forEach(a,function(a){var d=a.data.items;angular.forEach(d,function(a){if(void 0!==a){var d=a.id,e=b.indexOf(d);i.musics[e].title=a.snippet.title,i.musics[e].duration=g.getTime(a.contentDetails.duration),i.musics[e].ytdata=a,a.status.embeddable===!1&&c.push({position:e})}})}),angular.forEach(c,function(a){i.musics.splice(a.position,1)})}).then(function(){i.musics.sort(function(a,b){return a.rank=parseInt(a.rank)||0,b.rank=parseInt(b.rank)||0,b.rank>a.rank?1:b.rank<a.rank?-1:0})}).then(function(){a.loading=!1,k(),i.ytVars.autoplay=1,i.music.pos=0,i.play()})})},a.formSubmit=function(){var b=a.getUrlPathInfo(this.eventLink);c.path("/playlist/"+b)},a.getUrlPathInfo=function(a){var b=document.createElement("a");if(b.href=a,"facebook.com"!==b.host&&"www.facebook.com"!==b.host)return!1;var c=/(\d+)/g,d=a.match(c);if(void 0===d[0])return!1;var e=d[0];return e},a.playerTooglePlay=function(){i.tooglePlay()===!1?a.ytPlayer.stopVideo():a.ytPlayer.playVideo()},a.playerNext=function(){i.forward(),a.ytPlayer.playVideo()},a.playerPrevious=function(){i.backward(),a.ytPlayer.playVideo()},a.playerToogleShuffle=function(){a.shuffle=i.toogleShuffle()},a.listItemClick=function(b,c){i.music.pos=c,i.music.ytid=b.ytid,a.setNewListItemPos(),a.ytPlayer.playVideo()},a.$on("youtube.player.ended",function(){a.playerNext()}),a.$on("youtube.player.ready",function(){a.setNewListItemPos()}),a.$on("youtube.player.playing",function(){i.music.title=i.musics[i.music.pos].title,i.play()}),a.$on("youtube.player.paused",function(){i.stop()}),a.setNewListItemPos=function(){var a=document.getElementsByClassName("list-group-item active");if(0===a.length)return!1;var b=a[0].offsetTop;document.getElementsByClassName("music-list")[0].scrollTop=b},a.getLoginStatus=function(){f.getLoginStatus(function(b){"connected"===b.status?a.logged=!0:a.logged=!1})},a.$watch(function(){return f.isReady()},function(){a.logged=!0}),a.logged=!1,a.loading=!0,a.error=[],a.error.status=!1,f.getLoginStatus(function(b){"connected"===b.status?(a.logged=!0,a.init()):(a.logged=!1,c.path("/"))}),j(function(){k()},1e3)}]),angular.module("evplaylistsApp").factory("Page",["configs",function(a){var b=a.appName;return{getTitle:function(){return b},setTitle:function(b){document.title=a.appName+" - "+b}}}]),angular.module("evplaylistsApp").service("Youtube",["$http",function(a){function b(a,b){for(var c=a+"";c.length<b;)c="0"+c;return c}function c(a){var c=Math.floor(a/3600),d=a%3600,e=Math.floor(d/60),f=d%60,g=Math.ceil(f),h={hours:b(c,2),minutes:b(e,2),seconds:b(g,2)};return h}this.getId=function(a){var b=/^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;return void 0===a?!1:a.match(b)?RegExp.$1:!1},this.getTime=function(a){var b,d=/^PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?$/,e=0,f=0,g=0;if(d.test(a)){var h=d.exec(a);h[1]&&(e=Number(h[1])),h[2]&&(f=Number(h[2])),h[3]&&(g=Number(h[3])),b=3600*e+60*f+g}return c(b)},this.getData=function(b,c){var d="AIzaSyCJf9YsNK-d7MvMPg-B_Ov-awo10z816Qw",e="https://www.googleapis.com/youtube/v3/videos?id="+b+"&key="+d+"&maxResults=50&part=snippet,contentDetails,status";return console.log(e),a.get(e)}}]),angular.module("evplaylistsApp").service("Player",function(){this.musics=[],this.music={pos:0,ytid:"",title:"",band:""},this.playing=!1,this.shuffle=!1,this.ytVars={controls:1,disablekb:0,iv_load_policy:3,modestbranding:1,showinfo:0,autoplay:0},this.reset=function(){this.musics=[],this.music={pos:0,ytid:"",title:"",band:""},this.playing=!1,this.shuffle=!1},this.toogleShuffle=function(){return this.shuffle=!this.shuffle,this.shuffle},this.tooglePlay=function(){return this.playing=!this.playing,this.playing},this.forward=function(){this.shuffle===!0?this.music.pos=Math.floor(Math.random()*this.musics.length+1):this.music.pos++,this.music.pos>=this.musics.length&&(this.music.pos=0),this.play()},this.backward=function(){this.music.pos--,this.music.pos<0&&(this.music.pos=0),this.play()},this.play=function(){this.music.ytid=this.musics[this.music.pos].ytid,this.playing=!0},this.stop=function(){this.playing=!1}}),angular.module("evplaylistsApp").constant("configs",{appName:"EvPlaylist",appVersion:"0.1 Beta",keywords:"facebook, playlist, music, events",fbid:"702617786536819"}).config(["FacebookProvider",function(a){a.init("702617786536819")}]);